---
title: "Heatmaps with R"
output: html_notebook
---

# Objectives

In this section we will learn how to create **heatmaps**,
a popular graphical method for visualizing high-dimensional data. Heatmaps:

* visualize data that are in a form of a table or a matrix, whose
entries are numbers corresponding to some variables. 
* encode the information in the tables as a grid of colored cells. 
* are used in many fields to visualize observations, correlations, sparsity
or missing data patterns.

The rows and the columns of the heatmas are usually ordered to highlight the patterns
in the data, and are usually accompanied by 
dendograms^[https://www.r-statistics.com/2016/05/heatmaply-interactive-heat-maps/#more-61399].


The material presented here is largely based on the following resources:

* [Making heatmaps with R for microbiome analysis](http://www.molecularecologist.com/2013/08/making-heatmaps-with-r-for-microbiome-analysis/) tutorial
* [`heatmaply` vignette](https://cran.r-project.org/web/packages/heatmaply/vignettes/heatmaply.html)
* [`plotly` example](https://plot.ly/r/heatmaps/)


All presented material is under a 
[Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License]
(https://creativecommons.org/licenses/by-sa/4.0/).

# Install and load packages

```{r check-install-load-packages, warning=FALSE, message=FALSE}
# Clear the workspace
rm(list = ls())

# List of package needed for this workshop
reqpkg <- c("gplots", "plotly", "heatmaply", "RColorBrewer")

# Check if the packages are installed:
inpkg = installed.packages()[, "Package"] #installed packages
neededpkg = reqpkg[!reqpkg %in% inpkg]
if(length(neededpkg) > 0){
  stop(paste("\n Need to install the following package:", neededpkg))
}

# Load all required packages and show version
for(i in reqpkg){
	print(paste(i, "version:", packageVersion(i)))
	library(i, quietly=TRUE, verbose=FALSE, warn.conflicts=FALSE, character.only=TRUE)
}
```


# Chose a dataset

**Motor Trend Car Road Tests**

> The data was extracted from the 1974 Motor Trend US magazine, and comprises 
fuel consumption and 10 aspects of automobile design and performance for 32 
automobiles (1973â€“74 models).

```{r}
?mtcars
head(mtcars)
```

# Generate a basic heatmap

Using basic `stats::heatmap` function:

```{r}
heatmap(as.matrix(mtcars), Rowv = NA, Colv = NA)
```

Using `plotly` package you can get an interactive heatmap:
```{r}
library(plotly)
plot_ly(z = as.matrix(mtcars), type = "heatmap", colorscale = "Hot")
```


# More complicated heatmaps

With ordered rows and columns and the dendograms showing the rows and columns
clusters.

Using `heatmap()`
```{r}
heatmap(as.matrix(mtcars))
```

Using `gplots::heatmap.2()`:

```{r fig.height=6, fig.width = 7}
heatmap.2(as.matrix(mtcars))
```

You can also add the side colors and your own dendogram:


```{r fig.height=6, fig.width = 7}
# Define color scheme
scaleredblues <- colorRampPalette(colors = rev(brewer.pal(9, "RdBu")))(100)

# Cluster rows
data.dist.r <- dist(mtcars, method = "manhattan")
row.clus <- hclust(data.dist.r, "aver")

# Cluster columns
data.dist.c <- dist(t(mtcars), method = "manhattan")
col.clus <- hclust(data.dist.c, "aver")

# Create a variable for side bar
varCyl <- brewer.pal(9, "Set1")[mtcars$cyl]

heatmap.2(as.matrix(mtcars),
          Rowv = as.dendrogram(row.clus), 
          Colv = as.dendrogram(col.clus), 
          col = scaleredblues, 
          RowSideColors = varCyl) # this puts in the annotation for the samples margins = c(10, 3))
```


```{r fig.height=6, fig.width = 7}
heatmap.2(as.matrix(mtcars),
          Rowv = as.dendrogram(row.clus), 
          Colv = as.dendrogram(col.clus), 
          col = scaleredblues, 
          RowSideColors = varCyl,
          margins = c(6, 9), 
          trace = "none", density.info = "none", 
          xlab = "variables", ylab = "cars", 
          main = "Heatmap example", lhei = c(2, 8))
```

# `heatmaply` for complex interactive heatmaps

```{r}
library(heatmaply)
heatmaply(mtcars)
```

```{r}
heatmaply(mtcars) %>% layout(margin = list(l = 150, b = 50))
```


Heatmaps with the variable correlations:

```{r}
heatmaply(cor(mtcars), limits = c(-1,1)) %>% 
  layout(margin = list(l = 40, b = 40))
```

Color the dendogram branches:

```{r}
heatmaply(as.matrix(mtcars), k_col = 2, k_row = 3) %>% 
  layout(margin = list(l = 150, b = 160), autosize = F, width = 500, height = 600)
```


```{r}
heatmaply(as.matrix(mtcars), colors = scaleredblues, k_col = 2, k_row = 3) %>% 
  layout(margin = list(l = 150, b = 160), autosize = F, width = 500, height = 600)
```


# Exercise 

Microbiome dataset from DIABIMMUNE study on the dynamics of the infant gut
mictobiome and the development of type I diabetes (T1D).

Download a table of read counts: 

```{r}
dataUrl <- "https://pubs.broadinstitute.org/diabimmune/uploads/attachments/82/diabimmune_t1d_16s_otu_table.txt"
download.file(dataUrl, "./data/readCounts.txt")
```

```{r}
dataTable <- read.table("./data/readCounts.txt")
dim(dataTable)
taxTable <- dataTable[, 779:ncol(dataTable)]
dataTable <- dataTable[, 1:778]
```

Subset the table:

```{r}
dat <- dataTable[sample(1:nrow(dataTable), 150), sample(1:ncol(dataTable), 30)]
head(dat)
```

Generate the heatmap using `gplots::heatmap.2` with a chosen color scheme
and set `trace = "none", density.info = "none"`

```{r fig.height=6, fig.width = 5}
# (? ...)
```

You can install a useful color scheme package `viridis`:

```{r}
#install.packages("viridis")
library(viridis)
```



Generate an interactive heatmap using `heatmaply`:

```{r fig.height=6, fig.width = 5}
# (? ...)
```

